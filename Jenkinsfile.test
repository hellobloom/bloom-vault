pipeline {
  agent {
    kubernetes {

      label 'bloom-vault-agent-00004'
      defaultContainer 'jnlp'
      yaml """
apiVersion: v1
kind: Pod
metadata:
labels:
  component: ci
spec:
  serviceAccountName: jenkins
  containers:
  - name: docker
    image: docker:latest
    command:
    - cat
    tty: true
    volumeMounts:
    - mountPath: /var/run/docker.sock
      name: docker-sock
  - name: ubuntu
    image: ubuntu:20.04
    command:
    - cat
    tty: true
  volumes:
    - name: docker-sock
      hostPath:
        path: /var/run/docker.sock
"""
    }
  }
  environment {
    DOCKER_ACCT    = "hellobloom"                       // Dockerhub  account
    REPO_NAME      = 'bloom-vault'                       // Dockerhub image name
    DOCKER_IMAGE   = "${DOCKER_ACCT}/${REPO_NAME}"       // Dockerhub image
    CHARTS_REPO    = 'bloom-charts'                      // Dockerhub image name
    DOCKERHUB_ID   = 'dockerhub-creds'                   // Dockerhub credentials
    SSH_KEY        = credentials('bloom-vault-ssh-key')  // Bloom Vault ssh key
    NPMRC          = credentials('bloom-vault-npmrc')    // NPM token
    DOCKER_ARG     = "-q --build-arg SSH_KEY=${SSH_KEY} --build-arg NPMRC=${NPMRC} -f Dockerfile ."
    SLACK_CHAN     = '#jenkins-dev'
  }
  parameters {
    booleanParam(name: 'DEBUG', defaultValue: false, description: 'Debuggin mode')
  }
  stages {
    stage( 'Pre' ) {
      steps {
        container('docker') {
          sh """
            echo "Checking envvars."
            if ${DEBUG}; then
              printenv; ls -AlF ..;
            fi
            if test -z ${SSH_KEY}; then
              echo "ERROR: SSH_KEY must be set"
              exit 2
            fi
            if test -z ${NPMRC}; then
              echo "ERROR: NPMRC must be set"
              exit 2
            fi
          """
        }
      }
    }
    stage('Docker Image Build and Push') {
      steps {
        container('docker') {
          script {
            docker.withRegistry('', DOCKERHUB_ID) {
              def dockerImage = docker.build(
                "${DOCKER_IMAGE}:${GIT_COMMIT}",
                "${DOCKER_ARG}"
              )
              dockerImage.push()
              dockerImage.push('latest')
            }
          }
        }
      }
    }
    stage('Test') {
      steps {
        container('ubuntu') {
          withCredentials([file(credentialsId: 'bloom-vault-env-docker', variable: 'ENV_DOCKER')]) {
          sh """
          ls -al

          echo "Setting DEBIAN_FRONTEND to noninteractive for zero interaction while installing or upgrading the system via apt"
          export DEBIAN_FRONTEND="noninteractive"


          echo "Installing Node 10"
          # https://github.com/nodesource/distributions/blob/master/README.md
          curl -sL https://deb.nodesource.com/setup_10.x | sudo -E bash -
          sudo apt-get install -y nodejs

          echo "Node / NPM Versions"
          node -v
          npm -v

          echo "Installing docker"
          # https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=94798094
          sudo apt-get install apt-transport-https ca-certificates curl software-properties-common
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
          sudo add-apt-repository  "deb [arch=amd64] https://download.docker.com/linux/ubuntu  $(lsb_release -cs) stable"
          sudo apt-get update
          sudo apt-get -y install docker-ce
          sudo systemctl status docker
          sudo docker run hello-world

          echo "Installing docker-compose"
          sudo curl -L https://github.com/docker/compose/releases/download/1.17.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

          """
          }
        }
      }
    }
    stage('Chart Update and Package') {
      steps {
        build(
            job: "../${CHARTS_REPO}/${GIT_BRANCH}",
            parameters: [[$class: 'StringParameterValue', name: 'BLOOM_REPO', value: "${REPO_NAME}"],
                         [$class: 'StringParameterValue', name: 'COMMIT_HASH', value: "${GIT_COMMIT}"],
                         [$class: 'BooleanParameterValue', name: 'DEBUG', value: "${params.DEBUG}"]]
          )
      }
    }
  }
  post {
    success {
      slackSend channel: "${SLACK_CHAN}",
                color: 'good',
                message: "Pipeline ${currentBuild.fullDisplayName} success. ${DOCKER_IMAGE}:${GIT_COMMIT}"
    }
    unstable {
      slackSend channel: "${SLACK_CHAN}",
                color: 'warning',
                message: "Pipeline ${currentBuild.fullDisplayName} unstable. ${DOCKER_IMAGE}:${GIT_COMMIT}"
    }
    unsuccessful {
      slackSend channel: "${SLACK_CHAN}",
                color: 'danger',
                message: "Pipeline ${currentBuild.fullDisplayName} unsuccessful. ${DOCKER_IMAGE}:${GIT_COMMIT}"
    }
  }
}
